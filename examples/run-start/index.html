<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Focus-no-Jutsu demo</title>
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="missions/dialog.css">
    <link rel="stylesheet" href="missions/tabs.css">
    <link rel="stylesheet" href="missions/player.css">
    <meta name="description" content="A demo of focus-bagel">
  </head>
  <body>
    <div id="app">
      <header>
        <h1><code>Focus-no-Jutsu</code> 范例</h1>
      </header>

      <p>该范例页面使用 <code>Focus-no-Jutsu</code> 控制和管理焦点，是一个<a href="https://www.w3.org/WAI/ARIA/apg/practices/keyboard-interface/">键盘可访问的界面</a>，您可以任意选择鼠标和键盘访问该页面。</p>
      
      <p>网页程序里有很多需要焦点控制的场景，例如弹窗、菜单、选项卡、抽屉等等，在我们按下键盘的 <kbd>Tab</kbd> ，焦点进入某个场景，我们希望焦点被施加一个幻术，让焦点陷入一个循环，或者被卡在首尾元素之间的秘密空间，直到我们按下 <kbd>Esc</kbd> 或者点击“返回”，解开幻术。</p>

      <p>现在开始我们用 <code>Focus-no-Jutsu</code> 完成和焦点控制有关的一系列任务！🥷</p>

      <!-- <hr />

      <div>
        <button id="b0">E</button>
        <button id="b1">D</button>
        <button>C</button>

        <button>B</button>
        <button id="b2">A</button>
        <button>S</button>
      </div> -->


      <!-- <hr />

      <button id="t1">第一</button>
      <ul tabindex="0" id="cover">
        <li><button id="l1">测试</button></li>
        <li><button>测试</button></li>
        <li><button>测试</button></li>
        <li><button>测试</button></li>
        <li><div tabindex="0">测试<div tabindex="0">asdf<div tabindex="0">asdf</div></div></li>
        <li><button id="l9">测试</button></li>
      </ul>
      <button>最后</button> -->


      <h2>对话框</h2>

      <p>对话框通常是一个弹窗，当 <kbd>Tab</kbd> 访问到“打开”按钮，焦点聚焦按钮，<kbd>Enter</kbd>（或者 <kbd>Space</kbd> 和鼠标点击）触发“打开”之后，弹出对话框，焦点聚焦对话框的首个可聚焦元素，这时如果继续 <kbd>Tab</kbd>，焦点只能访问对话框内的元素，不能逃出对话框或者回到“打开”按钮，最后，我们按下 <kbd>Esc</kbd> 或者触发“返回”按钮，焦点回到“打开”按钮。</p>

      <button class="button" id="open" aria-haspopup="dialog" aria-expanded="false" aria-controls="dialog">打开一包糖</button>
      <div id="dialog_mask" class="closed_mask"></div>
      <div id="dialog" aria-modal="true" aria-labelledby="modal-title" class="dialog centre closedDialog" role="dialog" tabindex="-1">
        <h3 id="modal-title">吃一颗糖果</h3>
        <p>爱吃糖果的小可爱，你的糖果已送达，请注意查收。不需冷藏，无需加热，一颗提神醒脑，两颗永不疲劳，三颗长生不老～</p>
        <div class="ctrls">
          <button class="button" id="firstFocusBtn">巧克力！克力！力！</button>
          <button class="button" id="confirm">吃吃吃</button>
        </div>
        <button id="close" aria-label="Close" type="button">
          <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
        </button>
      </div>

      <details>
        <summary id="dialog_code">查看源码。</summary>

        <pre>
<code>const dialog = document.getElementById("dialog");
const mask = document.getElementById("dialog_mask");
const entry = document.getElementById("open");

const bagel = focusBagel(dialog, ["#firstFocusBtn", "#close"], {
  loop: false,
  entry: {
    node: entry,
    on: openDialog,
  },
  exit: {
    node: ["#close", "#firstFocusBtn", "#confirm", "#dialog_mask"],
    on: closeDialog,
  },
  onEscape: true,
});

function openDialog() {
  dialog.classList.add("openedDialog");
  dialog.classList.remove("closedDialog");
  dialog_mask.classList.remove("closed_mask");
  entry.ariaExpanded = true;
}

function closeDialog() {
  dialog.classList.remove("openedDialog");
  dialog.classList.add("closedDialog");
  dialog_mask.classList.add("closed_mask");
  entry.ariaExpanded = false;
}</code>
        </pre>
      </details>

      <h2 id="tablist">选项卡</h2>

      <p>选项卡包含一个选项卡列表和一个面板，切换选项卡的时候，改变选项卡面板的内容。<kbd>Tab</kbd> 首先访问选项卡列表，焦点落入选项卡列表，再次 <kbd>Tab</kbd> 焦点将离开选项卡。在选项卡列表里，使用 <kbd>Left Arrow</kbd> 和 <kbd>Right Arrow</kbd> 访问每一个选项卡，有的选项卡也支持使用 <kbd>Home</kbd> 和 <kbd>End</kbd> 聚焦第一个和最后一个选项卡。</p>

      <div id="tabs">
        <div id="tab_list" role="tablist" aria-labelledby="tablist">
          <button id="tab_1" role="tab" aria-selected="false" aria-controls="tabpanel_1" tabindex="0">
            <span>海棠</span>
          </button>
          <button id="tab_2" role="tab" aria-selected="false" aria-controls="tabpanel_2" tabindex="0">
            <span>梨花</span>
          </button>
          <button id="tab_3" role="tab" aria-selected="false" aria-controls="tabpanel_3" tabindex="0">
            <span>木绣球</span>
          </button>
          <button id="tab_4" role="tab" aria-selected="false" aria-controls="tabpanel_4" tabindex="0">
            <span>月见草</span>
          </button>
          <button id="tab_5" role="tab" aria-selected="true" aria-controls="tabpanel_5" tabindex="0">
            <span>桃花</span>
          </button>
        </div>
        <div id="tabpanel_1" role="tabpanel" aria-labelledby="tab_1" class="is-hidden">海棠</div>
        <div id="tabpanel_2" role="tabpanel" aria-labelledby="tab_2" class="is-hidden">梨花</div>
        <div id="tabpanel_3" role="tabpanel" aria-labelledby="tab_3" class="is-hidden">木绣球</div>
        <div id="tabpanel_4" role="tabpanel" aria-labelledby="tab_4" class="is-hidden">月见草</div>
        <div id="tabpanel_5" role="tabpanel" aria-labelledby="tab_5">桃花</div>
      </div>

      <details>
        <summary id="tags_code">查看源码。</summary>

        <pre>          
<code>const tabs = document.getElementById("tab_list");

const tabList = ["#tab_1", "#tab_2", "#tab_3", "#tab_4", "#tab_5"];
const tabsBagel = focusBagel(tabs, tabList, {
  onClick: onFocus,
  forward: {
    key: e => e.key === "ArrowRight",
    on: onFocus
  },
  backward: {
    key: e => e.key === "ArrowLeft",
    on: onFocus
  },
  exit: [{
    key: e => e.key === "Tab" && !e.shiftKey,
    target: "#tags_code",
  }, {
    key: e => e.key === "Tab" && e.shiftKey,
    target: "#dialog_code",
  }],
  entry: [{
    node: "#dialog_code",
    key: e => e.key === "Tab" && !e.shiftKey,
    type: "keydown",
  }, {
    node: "#tags_code",
    key: e => e.key === "Tab" && e.shiftKey,
    type: "keydown",
  }],
  removeListenersEachExit: false,
});

function onFocus({ prev, cur, prevI, curI }) {
  if (curI === prevI) return;
  prev.setAttribute("aria-selected", "false");
  cur.setAttribute("aria-selected", "true");
  const prevPanel = document.getElementById("tabpanel_" + (prevI + 1));
  const curPanel = document.getElementById("tabpanel_" + (curI + 1));
  prevPanel.classList.add('is-hidden');
  curPanel.classList.remove('is-hidden');
}</code>
        </pre>
      </details>

      <h2>播放列表</h2>

      <p>这个“播放列表”是一个真实例子，是 Spotify 的专辑界面，Spotify 网页有很好的键盘体验。如果有一类元素组成了列表，这类元素的每一个内部又包含很多可聚焦的子元素，这时使用 <kbd>Tab</kbd> 从头到尾的访问体验是崩溃的，因为元素太多、花费时间太长了。</p>
      
      <p>Spotify 是这样做的。一首专辑有多首单曲，首先 <kbd>Tab</kbd> 会聚焦整个专辑列表，继续 <kbd>Tab</kbd>，焦点将退出整个专辑列表，聚焦专辑列表的后一个元素；如果正在播放专辑中的某一首歌曲，首先 <kbd>Tab</kbd> 会聚焦整个专辑列表，继续 <kbd>Tab</kbd>，焦点不会退出专辑，而是会聚焦歌曲；退出专辑之后，回过头如果想要播放某一首歌，只要让焦点回到专辑列表，然后通过 <kbd>Up Arrow</kbd> 和 <kbd>Down Arrow</kbd> 来选中；听到动听的歌曲，我们会把这首歌曲收藏起来，当焦点回到歌曲，按下 <kbd>Left Arrow</kbd> 或者 <kbd>Right Arrow</kbd> 找到“收藏”按钮，就能进行后续的操作了。</p>

      <div class="player">
        <div class="head">
          <img class="cover_img" src="./assets/cover.jpg" alt="NARUTO -ナルト- オリジナルサウンドトラック">
          <div class="infos">
            <span class="type">专辑</span>
            <h3 class="title">NARUTO -ナルト- オリジナルサウンドトラック</h3>
            <div class="details">
              <a id="artist" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw" target="_blank">Toshio Masuda</a>
              <span class="dot"></span>
              <a href="https://open.spotify.com/artist/1HNngbrg0LENVuq56iQo0m" target="_blank">MUSASHI PROJECT</a>
              <span class="dot"></span>
              <span>2003</span>
              <span class="dot"></span>
              <span>20 首歌曲, </span>
              <span class="time">39 分钟 54 秒</span>
            </div>
          </div>
        </div>
        <div class="ctrls&body">
          <div class="ctrls">
            <div class="mock_play" tabindex="0"></div>
            <div class="mock_like" tabindex="0"></div>
            <div class="moke_more" tabindex="0"></div>
          </div>
          <div class="body">
            <div id="grid_wrapper" role="grid" aria-colcount="4" aria-rowcount="8" tabindex="0">
              <div class="table_head" role="presentation">
                <div class="table_head_inner" role="row" aria-rowindex="1">
                  <div role="columnheader" aria-colindex="1">#</div>
                  <div role="columnheader" aria-colindex="2">标题</div>
                  <div role="columnheader" aria-colindex="3" class="listeners_head">播放量</div>
                  <div role="columnheader" aria-colindex="4" aria-label="时长" class="time">
                    <svg role="img" height="16" width="16" aria-hidden="true" viewBox="0 0 16 16" data-encore-id="icon" class="time"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"></path><path d="M8 3.25a.75.75 0 0 1 .75.75v3.25H11a.75.75 0 0 1 0 1.5H7.25V4A.75.75 0 0 1 8 3.25z"></path></svg>
                  </div>
                </div>
              </div>
              <div id="songs_wrapper" class="cells_wrapper" role="presentation">
                <div id="song_1" role="row" aria-rowindex="2" aria-selected="false" class="song" tabindex="0">
                  <div role="gridcell" aria-colindex="1">
                    <span class="song_idx">1</span>
                    <button id="s1_play" class="song_play">▶️</button>
                  </div>
                  <div role="gridcell" aria-colindex="2">
                    <div class="title">オレがナルトだってばよ!</div>
                    <a id="s1_a" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw">Toshio Masuda</a>
                  </div>
                  <div role="gridcell" aria-colindex="3" class="listeners_cell">654,962</div>
                  <div role="gridcell" aria-colindex="4" class="last">
                    <button id="s1_like" class="song_like"></button>
                    <div>1:38</div>
                    <button id="s1_more" class="song_more"></button>
                  </div>
                </div>

                <div id="song_2" role="row" aria-rowindex="3" aria-selected="false" class="song" tabindex="0">
                  <div role="gridcell" aria-colindex="1">
                    <span class="song_idx">2</span>
                    <button id="s2_play" class="song_play">▶️</button>
                  </div>
                  <div role="gridcell" aria-colindex="2">
                    <div class="title">オレがナルトだってばよ!</div>
                    <a id="s2_a" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw">Toshio Masuda</a>
                  </div>
                  <div role="gridcell" aria-colindex="3" class="listeners_cell">654,962</div>
                  <div role="gridcell" aria-colindex="4" class="last">
                    <button id="s2_like" class="song_like"></button>
                    <div>1:38</div>
                    <button id="s2_more" class="song_more"></button>
                  </div>
                </div>

                <div id="song_3" role="row" aria-rowindex="4" aria-selected="false" class="song" tabindex="0">
                  <div role="gridcell" aria-colindex="1">
                    <span class="song_idx">3</span>
                    <button id="s3_play" class="song_play">▶️</button>
                  </div>
                  <div role="gridcell" aria-colindex="2">
                    <div class="title">オレがナルトだってばよ!</div>
                    <a id="s3_a" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw">Toshio Masuda</a>
                  </div>
                  <div role="gridcell" aria-colindex="3" class="listeners_cell">654,962</div>
                  <div role="gridcell" aria-colindex="4" class="last">
                    <button id="s3_like" class="song_like"></button>
                    <div>1:38</div>
                    <button id="s3_more" class="song_more"></button>
                  </div>
                </div>

                <div id="song_4" role="row" aria-rowindex="5" aria-selected="false" class="song" tabindex="0">
                  <div role="gridcell" aria-colindex="1">
                    <span class="song_idx">4</span>
                    <button id="s4_play" class="song_play">▶️</button>
                  </div>
                  <div role="gridcell" aria-colindex="2">
                    <div class="title">オレがナルトだってばよ!</div>
                    <a id="s4_a" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw">Toshio Masuda</a>
                  </div>
                  <div role="gridcell" aria-colindex="3" class="listeners_cell">654,962</div>
                  <div role="gridcell" aria-colindex="4" class="last">
                    <button id="s4_like" class="song_like"></button>
                    <div>1:38</div>
                    <button id="s4_more" class="song_more"></button>
                  </div>
                </div>

                <div id="song_5" role="row" aria-rowindex="6" aria-selected="false" class="song" tabindex="0">
                  <div role="gridcell" aria-colindex="1">
                    <span class="song_idx">5</span>
                    <button id="s5_play" class="song_play">▶️</button>
                  </div>
                  <div role="gridcell" aria-colindex="2">
                    <div class="title">オレがナルトだってばよ!</div>
                    <a id="s5_a" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw">Toshio Masuda</a>
                  </div>
                  <div role="gridcell" aria-colindex="3" class="listeners_cell">654,962</div>
                  <div role="gridcell" aria-colindex="4" class="last">
                    <button id="s5_like" class="song_like"></button>
                    <div>1:38</div>
                    <button id="s5_more" class="song_more"></button>
                  </div>
                </div>

                <div id="song_6" role="row" aria-rowindex="7" aria-selected="false" class="song" tabindex="0">
                  <div role="gridcell" aria-colindex="1">
                    <span class="song_idx">6</span>
                    <button id="s6_play" class="song_play">▶️</button>
                  </div>
                  <div role="gridcell" aria-colindex="2">
                    <div class="title">オレがナルトだってばよ!</div>
                    <a id="s6_a" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw">Toshio Masuda</a>
                  </div>
                  <div role="gridcell" aria-colindex="3" class="listeners_cell">654,962</div>
                  <div role="gridcell" aria-colindex="4" class="last">
                    <button id="s6_like" class="song_like"></button>
                    <div>1:38</div>
                    <button id="s6_more" class="song_more"></button>
                  </div>
                </div>

                <div id="song_7" role="row" aria-rowindex="8" aria-selected="false" class="song" tabindex="0">
                  <div role="gridcell" aria-colindex="1">
                    <span class="song_idx">...</span>
                    <button id="s7_play" class="song_play">▶️</button>
                  </div>
                  <div role="gridcell" aria-colindex="2">
                    <div class="title">...</div>
                    <a id="s7_a" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw">...</a>
                  </div>
                  <div role="gridcell" aria-colindex="3" class="listeners_cell">...</div>
                  <div role="gridcell" aria-colindex="4" class="last">
                    <button id="s7_like" class="song_like"></button>
                    <div>...</div>
                    <button id="s7_more" class="song_more"></button>
                  </div>
                </div>
              </div>
            </div>
            <div class="other_infos">
              <div>2003年3月19日</div>
              <div class="copyright">℗ 2003 TV Tokyo, SME Visual Works Inc.</div>
            </div>
          </div>
        </div>
        <div class="footer">
          <div class="more">
            <a id="more_from" class="more_1" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw/discography" target="_blank">更多来自 Toshio Masuda 的内容</a>
            <a class="more_2" href="https://open.spotify.com/artist/78JmbZfna6DOfhSoxccZZw/discography" target="_blank">查看唱片目录</a>
          </div>
        </div>
      </div>

      <details>
        <summary>查看源码。</summary>
        <pre>
<code>const songs = ["#song_1", "#song_2", "#song_3", "#song_4", "#song_5", "#song_6", "#song_7"];

let lastSong = null;

const playerBagel = focusBagel("#songs_wrapper", songs, {
  next: e => e.key === "ArrowDown",
  prev: e => e.key === "ArrowUp",
  exit: [{
    key: e => e.key === "Tab" && !e.shiftKey,
    target: "#more_from",
  }, {
    key: e => e.key === "Tab" && e.shiftKey,
    target: "#grid_wrapper",
  }],
  entry: {
    node: "#grid_wrapper",
    key: (e, active) => (e.key === "Tab" && !e.shiftKey && active > -1) || e.key === "ArrowDown" || e.key === "ArrowUp",
    type: "keydown",
  },
  onMove({ cur, prev, curI }) {
    prev?.classList.remove("focused");
    cur?.classList.add("focused");

    lastSong?.removeListeners();
    if (curI > -1) initSongBagel(curI);
  },
  correctionTarget({ lastI, last }) {
    if (lastI === -1)
      return "#grid_wrapper";
    return last;
  },
  removeListenersEachExit: false,
});

playerBagel.addForward("grid", {
  node: "#grid_wrapper",
  key: (e, active) => (e.key === "Tab" && !e.shiftKey && active === -1),
  target: "#more_from",
});

function initSongBagel(curI) {
  const idx = curI + 1;
  const list = [`#s${idx}_play`, `#s${idx}_a`, `#s${idx}_like`, `#s${idx}_more`];
  lastSong = focusBagel(`#song_${idx}`, list, {
    entry: {
      node: `#song_${idx}`,
      key: e => e.key === "ArrowRight" || e.key === "ArrowLeft",
      type: "keydown",
    },
    next: e => e.key === "ArrowRight",
    prev: e => e.key === "ArrowLeft",
    exit: {
      type: "outlist",
      target: false,
    },
    correctionTarget: false,
  });
}</code>
      </pre>
      </details>

      <!-- <h2>菜单</h2>

      <h2>复选框</h2> -->
    </main>
  </body>
  <script src="demo.js"></script>
  <script src="missions/dialog.js"></script>
  <script src="missions/tabs.js"></script>
  <script src="missions/player.js"></script>

  <script>
    // const bg = focusBagel(["#b1", "#b2"], {
    //   onEscape: true,
    // });

    // focusBagel(["#l1", "#l9"], {
    //   cover: true,
    //   onEscape: true,
    // })

  </script>
</html>